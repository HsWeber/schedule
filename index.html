<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>7人共享日程表</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    table {
      margin: auto;
      border-collapse: collapse;
      min-width: 700px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px 15px;
      min-width: 70px;
      cursor: pointer;
      user-select: none;
    }
    th {
      background-color: #eee;
    }
    .available {
      background-color: lightgreen;
    }
    .unavailable {
      background-color: #f0f0f0;
    }
    td:first-child {
      cursor: default;
      background-color: #fafafa;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>7人共享日程表</h1>
  <p>点击格子切换“有空 / 无空”状态，数据会自动同步到 Firebase。</p>
  <table id="scheduleTable">
    <thead>
      <tr>
        <th>时间段</th>
        <th>翁</th>
        <th>郭</th>
        <th>董</th>
        <th>施</th>
        <th>熊</th>
        <th>高（壁画很多）</th>
        <th>高</th>
      </tr>
    </thead>
    <tbody id="scheduleBody"></tbody>
  </table>

  <script>
    const days = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'];
    const periods = ['上午', '下午', '晚上'];
    const people = ['翁', '郭', '董', '施', '熊', '高大', '高小'];
    const tableBody = document.getElementById('scheduleBody');

    // 生成表格行和格子，不绑定点击事件
    days.forEach(day => {
      periods.forEach(period => {
        const row = document.createElement('tr');
        const timeCell = document.createElement('td');
        timeCell.textContent = `${day} ${period}`;
        row.appendChild(timeCell);

        people.forEach(person => {
          const cell = document.createElement('td');
          cell.classList.add('unavailable');
          cell.dataset.time = `${day}_${period}`;
          cell.dataset.person = person;
          row.appendChild(cell);
        });

        tableBody.appendChild(row);
      });
    });
  </script>

  <!-- 引入 Firebase 兼容版 SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // 你的 Firebase 配置信息
    const firebaseConfig = {
      apiKey: "AIzaSyBPK4UAPp7l4TUX394YALfqaRAOk0Ectd0",
      authDomain: "schedule-4a6a7.firebaseapp.com",
      databaseURL: "https://schedule-4a6a7-default-rtdb.firebaseio.com",
      projectId: "schedule-4a6a7",
      storageBucket: "schedule-4a6a7.firebasestorage.app",
      messagingSenderId: "33975824974",
      appId: "1:33975824974:web:f784d34d2ffe2a2ee4c91f",
      measurementId: "G-JP7PD9ECEQ"
    };

    // 初始化 Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 更新数据库中的“是否有空”状态
    function updateSchedule(time, person, available) {
      db.ref(`schedule/${time}/${person}`).set(available)
        .then(() => console.log(`写入成功: ${time} ${person} = ${available}`))
        .catch(err => console.error('写入失败:', err));
    }

    // 监听数据库变化，更新表格显示
    function loadSchedule() {
      db.ref('schedule').on('value', snapshot => {
        const data = snapshot.val() || {};
        document.querySelectorAll('td[data-time]').forEach(cell => {
          const { time, person } = cell.dataset;
          if (data[time] && data[time][person]) {
            cell.classList.add('available');
            cell.classList.remove('unavailable');
          } else {
            cell.classList.remove('available');
            cell.classList.add('unavailable');
          }
        });
      });
    }

    // 绑定点击事件，切换状态并写数据库
    function bindClickEvents() {
      document.querySelectorAll('td[data-time]').forEach(cell => {
        cell.addEventListener('click', () => {
          const current = cell.classList.contains('available');
          const { time, person } = cell.dataset;
          updateSchedule(time, person, !current);
          // 本地先切换，数据库回调同步最终状态
          cell.classList.toggle('available', !current);
          cell.classList.toggle('unavailable', current);
        });
      });
    }

    loadSchedule();
    bindClickEvents();
  </script>
</body>
</html>
